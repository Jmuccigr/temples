#!/bin/bash

# Converts Zotero-produced json bib file into html

# Set up some variables
me=$(whoami)
dest="/Users/$me/Documents/github/local/temples"
temp=$(echo $TMPDIR | sed 's:/$::')

# Path to include homebrew stuff like pandoc for running via launchctl
export PATH="/usr/local/bin:$PATH"

# Convert the json file to html directly.
pandoc -f csljson "$dest/temple_bib.json" --citeproc -s -o  "$dest/temple_bib.html" --metadata title="Bibliography for temple database"

# Make sure that it went ok before proceeding
if [ $? -ne 0 ]
	then
	echo "$(date +%Y-%m-%d\ %H:%M:%S)" 1>&2
	exit
fi

if [ $(stat -f %z "$dest/temple_bib.html") -eq 0 ]
	then
	echo "$(date +%Y-%m-%d\ %H:%M:%S) No references generated by pandoc-citeproc" 1>&2
	exit
fi

# Also generate a simple csv with key and citation strings in plain text and html
csv=`grep 'div id="ref-' "$dest/temple_bib.html" | perl -pe 's/^.*ref\-(.+?)\".*$/\1/' | perl -pe 's/ /\n\n/g' | perl -pe 's/(.+)/\1, @\1/g'`

# Run this through pandoc, once for each format
# Feed pandoc a modified chicago-style csl where the citation is replaced by the bibliography
# Plain text
plain=`echo "$csv" | pandoc --citeproc --wrap=preserve --bibliography=$dest/temple_bib.json --csl=$dest/chicago-author-date.csl -t plain | perl -pe 's/^([^\s]+? )/"\1"/' | perl -pe 's/,\s/",/' | perl -pe 's/(.)\.(\‚Äù)*$/\1\2"/'`

# HTML
html=`echo "$csv" | pandoc --citeproc --wrap=preserve --bibliography=$dest/temple_bib.json --csl=$dest/chicago-author-date.csl -t html | perl -pe 's/<(p|\/p)>//' | perl -pe 's/<span class=.*?>//g' | perl -pe 's/"/\\\"/g' | perl -pe 's/^.+?,\s/"/' | perl -pe 's/<\/span>$/"/'`

# Combine two formats into final output file
paste -d , <(printf %s "$plain") <(printf %s "$html") > $dest/bibliography.csv

# Check the output to make sure all items in Zotero are appearing

# Search it all & generate list in one go
result=`for i in $(csvcut -c 3 "$dest/citations.csv"); do echo -en "$i\t"; grep -c "$i" "$dest/temple_bib.json"; done | grep "\t0" | sort | uniq | perl -pe 's/\t0$//' | perl -pe 's/\n/, /' | sed 's/, $//'`

if [[ -n $result ]]
then
  err="$(date +%Y-%m-%d\ %H:%M:%S) The following citations appear in the citations.csv, but not in the bibliography outputted from Zotero:"
  echo $err "$result" 1>&2
else
  echo "$(date +%Y-%m-%d\ %H:%M:%S) No missing citations" 1>&2
fi
